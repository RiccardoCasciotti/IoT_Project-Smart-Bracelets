# Smart Bracelets

The project aims to implement smart bracelets which can be used by parents to keep track of their kids when playing at a playground for example.

Riccardo Casciotti 10806697
Paolo Ritirato 10868927

PositionSensorP.nc:

    -provides the fake value for the status read with the probability distribution requested using a random generated number and considering it's module by 10.


PositionSensorC.nc:

    -connects components for PositionSensorP.


SmartBracelet.h:
- In the library we defined the data structures representing the radio packet used by the bracelets and the status generated by the sensor. 

    - Radio packet
        - As random prestored keys we used 20 chars long strings which are stored, during the pairing phase, in the "data" array in the smartB_msg_t struct. 
        - The packet sent by motes contains also the coordinates of the position of the child mote. the message ID and the message type. 
        - The types of messages are: 0 for pairing phase, 1 for confirmation of the pairing by the child to the parent, 2 for operational phase where the child mote sends information to the parent, 3 alert mode. 
    
    - Status struct
        - It is used by the position sensor to represent the data it gathered.
        - It contains the coordinates of the position of the mote and a string "status" which contains the status of the child: STANDING, RUNNING, WALKING, FALLING.





SmartBraceletAppC.nc:
- This file links the components to the application.

    - Components
        -TimerMilliC() used for the pairing timer (0,25 seconds), the info timer ( 10 seconds ), the alert timer( 60 seconds ) 
        -The radio components to turn on and off the antenna, the ones to receive and send packets in between motes. 
        -The position sensor component for the position measurement of the child's bracelet. 


RunSimulation.py:

    -creates the 4 nodes for the simulation;
    -creates the file for the log;
    -adds the channels to the simulation;
    -runs the simulation and stops node 1 to simulate a disconnection after a certain amount of time.



FLOW:

Pairing mode:
    -starts the antenna and the timer for pairing at the boot;
    -when the timer for pairing is fired it is created and sent in broadcast a pairing message (msg_type = 0, data = prestored_key(tos_node_id/2)) only if the node is a parent (TOS_NODE_ID%2 ==0);
    -the pairing message is received -also- from the children that checks the preloaded key with the one arrived in the message and if they are equal it sends a confirmation message (msg_type = 1) to the parent requesting the ack;
    -the parent acks the confirmation message and both the bracelets switch to operational mode (mode =2), save the address for the coupled bracelet and assign 1 to paired variable;

Operational phase:
    - Once the pairing phase is completed the TimerInfo() is fired in a periodic way so that every 10 seconds the child sends his position information to the parent's bracelet. 
    - Once the sensor reading is completed the informations are loaded in the message struct used by the motes to communicate (  the message is sent using the send_position() function ).
    - The message is sent to the right parent because the child mote stores the address of the parent right after pairing is completed and is going to use that one to send all the info messages. 
    - If the parent receives a FALLING  info message from the child an ALERT is thrown.

Alert phase:
    - If the parent doesn't receive an INFO message from the child every at most 60 seconds a MISSING alarm is thrown and the last known position is notified. 

The convention to assign the child motes and the parent motes is that all the even TOS_IDs correspond to parents while all the odd ones to children.
And the TOS_IDs are then used to index the PRESTORED_KEY array used to store the static keys associated with motes and used to pair them (each key is a 20 char long string).
